<script>
  import "../app.css";
  import { user, logout } from "$lib/auth";
  import { goto } from "$app/navigation";
  import { page } from '$app/stores';
  import { browser } from '$app/environment';
  import { fetchCache } from "$lib/db";
  import { LogOut } from "lucide-svelte";
  import { onMount } from "svelte";

  /** @type {Props} */
  let { children } = $props();

  /** @type {App.Doctor[]} */
  let doctors = $state([]);
  let searchQuery = $state('');

  async function handleLogout() {
    await logout();
    goto('/upravljanje/prijava');
  }

  function handleSelection(doctor) {
    searchQuery = '';
    goto(`/doktori/${doctor.id}`);
  }

  function getFilteredDoctors() {
    if (!searchQuery) return [];
    return doctors.filter(doctor =>
      `${doctor.first_name} ${doctor.last_name}`.toLowerCase().includes(searchQuery.toLowerCase())
    );
  }

  function renderStars(rating) {
    const fullStars = Math.floor(rating);
    const halfStar = rating % 1 >= 0.5 ? 1 : 0;
    const emptyStars = 5 - fullStars - halfStar;

    return [
      ...Array(fullStars).fill('filled'),
      ...Array(halfStar).fill('half'),
      ...Array(emptyStars).fill('empty')
    ];
  }

  onMount(()=>{
    fetch('/api/doctors')
      .then(response => response.json())
      .then(data => {
        doctors = data;
      })
      .catch(error => {
        console.error('Error fetching doctors:', error);
      });
  });
</script>

<svelte:head>
  <title>Najdijabetolog</title>
  {#if fetchCache}
    <template id="loaded-data" style="display:none">{browser ? '' : Buffer.from(JSON.stringify(fetchCache)).toString('base64')}</template>
  {/if}
</svelte:head>

<!-- Navbar with improved mobile layout -->
<div class="navbar bg-[#ff8282] text-[black] p-2">
  <div class="w-full flex flex-wrap gap-2">
    <!-- First row: Logo and Search -->
    <div class="flex flex-1 items-center gap-2 min-w-0">
      <!-- Logo section -->
      <a href={$user ? `/upravljanje` : `/`} class="btn btn-ghost text-xl whitespace-nowrap">Najdijabetolog</a>
      
      <!-- Search section with properly contained dropdown -->
      <div class="relative flex-1 min-w-0">
        <div class="w-full md:max-w-md md:absolute md:right-0 top-[-14px]">
          <input
            type="text"
            placeholder="Pronaƒëite dijabetologa"
            class="input input-bordered input-sm w-full"
            bind:value={searchQuery}
          />
          {#if getFilteredDoctors().length > 0}
            <div class="fixed inset-x-0 md:absolute md:inset-x-auto md:w-full z-10 mt-1 bg-white shadow-lg rounded-lg border border-gray-200 max-h-48 overflow-y-auto mx-2 md:mx-0">
              {#each getFilteredDoctors() as doctor}
                <div
                  class="p-2 cursor-pointer hover:bg-gray-100 flex items-center justify-between space-x-4"
                  onclick={() => handleSelection(doctor)}
                >
                  <div class="flex items-center space-x-2">
                    <span class="text-yellow-500">üë®‚Äç‚öïÔ∏è</span>
                    <span>{doctor.first_name} {doctor.last_name}</span>
                  </div>
                  <div class="flex space-x-1" aria-label={`Rating: ${doctor.rating} out of 5`}>
                    {#each renderStars(doctor.rating) as star}
                      <svg
                        class="w-4 h-4 {star === 'filled' ? 'text-yellow-500' : star === 'half' ? 'text-yellow-500' : 'text-gray-300'}"
                        xmlns="http://www.w3.org/2000/svg"
                        fill="{star === 'filled' ? 'currentColor' : star === 'half' ? 'currentColor' : 'none'}"
                        viewBox="0 0 24 24"
                      >
                        <path
                          d="{star === 'half'
                            ? 'M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2v15.27z'
                            : 'M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z'}"
                        />
                      </svg>
                    {/each}
                  </div>
                </div>
              {/each}
            </div>
          {/if}
        </div>
      </div>
    </div>

    <!-- User section -->
    {#if $page.url.pathname.startsWith('/upravljanje') && $user}
      <div class="flex flex-wrap items-center justify-end gap-2 ml-auto">
        {#if $user.role === 'admin'}
          <a href="/upravljanje/korisnici" class="btn btn-ghost text-xl">Korisnici</a>
        {/if}
        <h1 class="font-bold">Dobrodo≈°li, {$user.username}!</h1>
        <button onclick={handleLogout} class="btn btn-secondary">
          <LogOut class="mr-2" size={18} />Odjava
        </button>
      </div>
    {/if}
  </div>
</div>

{@render children?.()}